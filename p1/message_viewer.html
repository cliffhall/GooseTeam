<!doctype html>
<html>
  <head>
    <title>Message Viewer</title>
    <style>
      /* Your existing styles go here */
    </style>
  </head>

  <body>
    <h1>Message Viewer</h1>
    <div class="controls">
      <button onclick="clearMessages()">Clear Display</button>
      <div id="connection-status" class="status disconnected">Disconnected</div>
      <div class="message-input" style="margin-top: 10px">
        <input
          type="text"
          id="messageInput"
          placeholder="Type your message..."
          style="padding: 8px; width: 300px; margin-right: 10px"
        />
        <button onclick="sendMessage()">Send</button>
      </div>
    </div>
    <div id="messages"></div>

    <script>
      const serverHost = "http://localhost:5175"; // Define the server host

      let eventSource = null;

      function formatTimestamp(timestamp) {
        return new Date(timestamp).toLocaleString();
      }

      function formatContent(content) {
        // Adjusting for JSON format or HTML-prepared responses
        return typeof content === "string"
          ? content
          : JSON.stringify(content, null, 2);
      }

      function updateConnectionStatus(connected) {
        const status = document.getElementById("connection-status");
        if (connected) {
          status.textContent = "Connected";
          status.className = "status connected";
        } else {
          status.textContent = "Disconnected";
          status.className = "status disconnected";
        }
      }

      function clearMessages() {
        document.getElementById("messages").innerHTML = "";
      }

      function addMessages(newMessages) {
        const messagesDiv = document.getElementById("messages");

        newMessages.forEach((msg) => {
          const messageDiv = document.createElement("div");
          messageDiv.className = "message";
          messageDiv.setAttribute("data-sender", msg.sender || "Unknown");

          if (msg.color) {
            messageDiv.style.borderLeftColor = msg.color;
          }

          const senderStyle = msg.color
            ? `background-color: ${msg.color};`
            : "";

          messageDiv.innerHTML = `
                    <div class="message-header">
                        <div class="timestamp">
                            ${formatTimestamp(msg.timestamp)}
                            <span class="sender" style="${senderStyle}" title="${msg.sender}">${msg.display_name || msg.sender}</span>
                        </div>
                    </div>
                    <div class="content">
                        ${formatContent(msg.content)}
                    </div>
                `;

          messagesDiv.appendChild(messageDiv);
        });
      }

      function connectSSE() {
        if (eventSource) {
          eventSource.close();
        }

        eventSource = new EventSource(`${serverHost}/sse`); // Use serverHost for SSE

        eventSource.onopen = function () {
          console.log("Connected to SSE");
          updateConnectionStatus(true);
        };

        eventSource.onmessage = function (event) {
          const messages = JSON.parse(event.data);
          addMessages([messages]); // Assuming each event contains one message
        };

        eventSource.onerror = function () {
          console.log("SSE connection closed");
          updateConnectionStatus(false);
          eventSource.close();
        };
      }

      function sendMessage() {
        const input = document.getElementById("messageInput");
        const message = input.value.trim();

        if (message) {
          fetch(`${serverHost}/message`, {
            // Use serverHost for POST request
            method: "POST",
            headers: {
              "Content-Type": "application/json",
              "X-Sender": "Human",
            },
            body: JSON.stringify({ content: message }),
          })
            .then((response) => {
              if (response.ok) {
                input.value = "";
              } else {
                console.error("Failed to send message");
              }
            })
            .catch((error) => {
              console.error("Error:", error);
            });
        }
      }

      // Allow sending message with Enter key
      document
        .getElementById("messageInput")
        .addEventListener("keypress", function (e) {
          if (e.key === "Enter") {
            sendMessage();
          }
        });

      // Initial connection
      connectSSE();
    </script>
  </body>
</html>
